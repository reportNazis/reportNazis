version: '3.8'

services:
  # Builder Service to compile Angular
  frontend-builder:
    build:
      context: .
      dockerfile: ./frontend-workspace/Dockerfile
    volumes:
      - frontend-dist:/output
    # Copy built artifacts from image (/app/dist) to volume (/output)
    command: /bin/sh -c "cp -r /app/dist/* /output/"

  gateway:
    image: nginx:alpine
    ports:
      - "${GATEWAY_PORT}:80"
    environment:
      - SERVICE_PORT=${SERVICE_PORT}
      - ZITADEL_PORT=${ZITADEL_PORT}
    volumes:
      - ./gateway/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      # Check volumes are populated by builder
      - frontend-dist:/usr/share/nginx/html:ro
    command: /bin/sh -c "envsubst '$${SERVICE_PORT} $${ZITADEL_PORT}' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    depends_on:
      frontend-builder:
        condition: service_completed_successfully
      form-service:
        condition: service_started
      management-service:
        condition: service_started
      log-service:
        condition: service_started
      zitadel:
        condition: service_started

  # --- ZITADEL SERVICES ---
  zitadel:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel:latest
    command: start-from-init --masterkey "${ZITADEL_MASTERKEY}"
    environment:
      ZITADEL_EXTERNALDOMAIN: localhost
      ZITADEL_EXTERNALSECURE: "${ZITADEL_EXTERALSECURE}"
      ZITADEL_TLS_ENABLED: "${ZITADEL_TLS_ENABLED}"

      ZITADEL_DATABASE_POSTGRES_HOST: ${ZITADEL_DB_HOST}
      ZITADEL_DATABASE_POSTGRES_PORT: ${ZITADEL_DB_PORT}
      ZITADEL_DATABASE_POSTGRES_DATABASE: ${ZITADEL_DB_NAME}
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${ZITADEL_DB_ADMIN_USER}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: ${ZITADEL_DB_USER}
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${ZITADEL_DB_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable

      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: ${LOGIN_CLIENT_PAT_PATH}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: "false"
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: ${LOGIN_CLIENT_USERNAME}
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: ${LOGIN_CLIENT_NAME}
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: '2029-01-01T00:00:00Z'

      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "true"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login
      ZITADEL_OIDC_DEFAULTLOGINURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/login?authRequest=
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/logout?post_logout_redirect=
      ZITADEL_SAML_DEFAULTLOGINURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/login?samlRequest=

    healthcheck:
      test: [ "CMD", "/app/zitadel", "ready" ]
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    volumes:
      - .:/current-dir:delegated
    ports:
      - "${ZITADEL_PORT}:8080"
      - "${ZITADEL_LOGIN_PORT}:3000"
    networks:
      - default
    depends_on:
      zitadel-db:
        condition: service_healthy

  login:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel-login:latest
    environment:
      - ZITADEL_API_URL=http://localhost:${ZITADEL_PORT}
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=${LOGIN_CLIENT_PAT_PATH}
    network_mode: service:zitadel
    volumes:
      - .:/current-dir:ro
    depends_on:
      zitadel:
        condition: service_healthy

  zitadel-db:
    restart: unless-stopped
    image: postgres:17
    environment:
      PGUSER: ${ZITADEL_DB_ADMIN_USER}
      POSTGRES_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${ZITADEL_DB_NAME} -U ${ZITADEL_DB_ADMIN_USER}" ]
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 20s
    ports:
      - "${ZITADEL_DB_PORT}:5432"
    volumes:
      - zitadel-data:/var/lib/postgresql/data
    networks:
      - default

  # --- APPLICATION SERVICES ---

  app-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${APP_DB_USER}
      - POSTGRES_PASSWORD=${APP_DB_PASSWORD}
      - POSTGRES_DB=${APP_DB_NAME}
    volumes:
      - app-db-data:/var/lib/postgresql/data
    # Internal only
    expose:
      - "5432"

  form-service:
    build:
      context: .
      dockerfile: ./form-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
      - DB_HOST=${APP_DB_HOST}
      - DB_NAME=${APP_DB_NAME}
      - DB_USER=${APP_DB_USER}
      - DB_PASSWORD=${APP_DB_PASSWORD}
    depends_on:
      - app-db
    deploy:
      replicas: 1

  management-service:
    build:
      context: .
      dockerfile: ./management-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
      - DB_HOST=${APP_DB_HOST}
      - DB_NAME=${APP_DB_NAME}
      - DB_USER=${APP_DB_USER}
      - DB_PASSWORD=${APP_DB_PASSWORD}
      - ZITADEL_ISSUER=http://zitadel:${ZITADEL_PORT}
    depends_on:
      - app-db
    deploy:
      replicas: 1

  log-service:
    build:
      context: .
      dockerfile: ./log-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
    deploy:
      replicas: 1

volumes:
  zitadel-data:
  app-db-data:
  frontend-dist:
    # Shared volume for frontend artifacts

networks:
  default:
