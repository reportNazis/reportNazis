services:
  # Builder Service to compile Angular
  frontend-builder:
    build:
      context: .
      dockerfile: ./frontend-workspace/Dockerfile
    volumes:
      - frontend-dist:/output
    # Copy built artifacts from image (/app/dist) to volume (/output)
    command: /bin/sh -c "cp -r /app/dist/* /output/"

  reverse-proxy:
    image: nginx:alpine
    ports:
      - "${GATEWAY_PORT}:80"
    environment:
      - SERVICE_PORT=${SERVICE_PORT}
      - ZITADEL_PORT=${ZITADEL_PORT}
    volumes:
      - ./reverse-proxy/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      # Check volumes are populated by builder
      - frontend-dist:/usr/share/nginx/html:ro
    command: /bin/sh -c "envsubst '$${SERVICE_PORT} $${ZITADEL_PORT}' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    depends_on:
      frontend-builder:
        condition: service_completed_successfully
      form-service:
        condition: service_started
      management-service:
        condition: service_started
      log-service:
        condition: service_started
      zitadel:
        condition: service_started

  # --- ZITADEL SERVICES ---
  zitadel:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel:latest
    command: start-from-init --masterkey "${ZITADEL_MASTERKEY}"
    environment:
      ZITADEL_EXTERNALDOMAIN: localhost
      ZITADEL_EXTERNALSECURE: "${ZITADEL_EXTERALSECURE}"
      ZITADEL_TLS_ENABLED: "${ZITADEL_TLS_ENABLED}"
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: ${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: ${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD}

      ZITADEL_DATABASE_POSTGRES_HOST: ${ZITADEL_DB_HOST}
      ZITADEL_DATABASE_POSTGRES_PORT: ${ZITADEL_DB_PORT}
      ZITADEL_DATABASE_POSTGRES_DATABASE: ${ZITADEL_DB_NAME}
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${ZITADEL_DB_ADMIN_USER}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: ${ZITADEL_DB_USER}
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${ZITADEL_DB_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable

      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: ${LOGIN_CLIENT_PAT_PATH}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: "false"
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: ${LOGIN_CLIENT_USERNAME}
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: ${LOGIN_CLIENT_NAME}
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: '2029-01-01T00:00:00Z'

      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "true"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login
      ZITADEL_OIDC_DEFAULTLOGINURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/login?authRequest=
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/logout?post_logout_redirect=
      ZITADEL_SAML_DEFAULTLOGINURLV2: http://localhost:${ZITADEL_LOGIN_PORT}/ui/v2/login/login?samlRequest=

    healthcheck:
      test: [ "CMD", "/app/zitadel", "ready" ]
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    volumes:
      - .:/current-dir:delegated
    ports:
      - "${ZITADEL_PORT}:8080"
      - "${ZITADEL_LOGIN_PORT}:3000"
    networks:
      - default
    depends_on:
      zitadel-db:
        condition: service_healthy

  login:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel-login:latest
    environment:
      - ZITADEL_API_URL=http://localhost:${ZITADEL_PORT}
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=${LOGIN_CLIENT_PAT_PATH}
    network_mode: service:zitadel
    volumes:
      - .:/current-dir:ro
    depends_on:
      zitadel:
        condition: service_healthy

  zitadel-db:
    restart: unless-stopped
    image: postgres:17
    environment:
      PGUSER: ${ZITADEL_DB_ADMIN_USER}
      POSTGRES_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${ZITADEL_DB_NAME} -U ${ZITADEL_DB_ADMIN_USER}" ]
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 20s
    ports:
      - "${ZITADEL_DB_PORT}:5432"
    volumes:
      - zitadel-data:/var/lib/postgresql/data
    networks:
      - default

  # --- APPLICATION SERVICES ---

  app-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${APP_DB_USER}
      - POSTGRES_PASSWORD=${APP_DB_PASSWORD}
      - POSTGRES_DB=${APP_DB_NAME}
    volumes:
      - app-db-data:/var/lib/postgresql/data
    # Internal only
    expose:
      - "5432"

  form-service:
    build:
      context: .
      dockerfile: ./form-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
      - DB_HOST=${APP_DB_HOST}
      - DB_NAME=${APP_DB_NAME}
      - DB_USER=${APP_DB_USER}
      - DB_PASSWORD=${APP_DB_PASSWORD}
    depends_on:
      - app-db
    deploy:
      replicas: 1

  identity-service:
    build:
      context: .
      dockerfile: ./identity-service-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
      - DB_HOST=${APP_DB_HOST}
      - DB_NAME=${APP_DB_NAME}
      - DB_USER=${APP_DB_USER}
      - DB_PASSWORD=${APP_DB_PASSWORD}
      - ZITADEL_ISSUER=http://zitadel:8080
      - ZITADEL_SERVICE_TOKEN_PATH=/app/login-client.pat
    volumes:
      - ./login-client.pat:/app/login-client.pat:ro
    depends_on:
      - app-db
      - zitadel
    deploy:
      replicas: 1

  log-service:
    build:
      context: .
      dockerfile: ./log-service/Dockerfile
    environment:
      - PORT=${SERVICE_PORT}
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
    networks:
      - internal
    deploy:
      replicas: 1

  # --- BFF GATEWAY SERVICES ---

  gateway-bff:
    build:
      context: .
      dockerfile: ./gateway-bff/Dockerfile
    ports:
      - "8000:8000" # Direct access for development
    environment:
      - DJANGO_SECRET_KEY=${BFF_SECRET_KEY}
      - DEBUG=${DEBUG:-false}
      - BACKEND_URL=http://backend-mock:8001
      - LOG_SERVICE_URL=http://log-service:${SERVICE_PORT}
      - REDIS_URL=redis://redis:6379/0
      - ZITADEL_ISSUER=http://zitadel:8080
      - JWT_AUDIENCE=${JWT_AUDIENCE:-gateway-bff}
      - JWKS_CACHE_TTL=${JWKS_CACHE_TTL:-3600}
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
      - CACHE_TTL_DEFAULT=${CACHE_TTL_DEFAULT:-300}
      - UPSTREAM_TIMEOUT=${UPSTREAM_TIMEOUT:-30}
    networks:
      - dmz
      - internal
      - cache
    # Security: Read-only filesystem
    read_only: true
    # Security: Non-root (defined in Dockerfile)
    security_opt:
      - no-new-privileges:true
    depends_on:
      - redis
      - backend-mock
      - log-service
    deploy:
      replicas: 1

  backend-mock:
    build:
      context: .
      dockerfile: ./backend-mock/Dockerfile
    environment:
      - DJANGO_SECRET_KEY=${BACKEND_MOCK_SECRET_KEY}
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
    networks:
      - internal
    # Security: Not exposed externally, only via internal network
    expose:
      - "8001"
    # Security: Read-only filesystem
    read_only: true
    security_opt:
      - no-new-privileges:true
    deploy:
      replicas: 1

  redis:
    image: redis:7-alpine
    networks:
      - cache
    # Security: Not exposed externally
    expose:
      - "6379"
    # Security: Read-only with data volume
    read_only: true
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    deploy:
      replicas: 1

volumes:
  zitadel-data:
  app-db-data:
  frontend-dist: # Shared volume for frontend artifacts
  redis-data:
    # Redis persistence

networks:
  default: # DMZ: Nginx <-> BFF Gateway (exposed to frontend layer)

  dmz:
    internal: false
  # Internal: Backend services only (not exposed externally)
  internal:
    internal: true
  # Cache: BFF <-> Redis only
  cache:
    internal: true
