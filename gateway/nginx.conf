events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # UUID Injection via request_id
    map $http_x_trace_id $trace_id {
        default $http_x_trace_id;
        ""      $request_id;
    }

    server {
        listen 80;

        # Add X-Trace-ID header to all responses for debugging
        add_header X-Trace-ID $trace_id always;

        # Frontend User App
        location / {
            root /usr/share/nginx/html/user;
            try_files $uri $uri/ /index.html;
        }

        # Frontend Admin App
        location /admin {
            alias /usr/share/nginx/html/admin;
            try_files $uri $uri/ /index.html;
        }

        # Management Service API
        location /api/mgmt/ {
            proxy_pass http://management-service:8000/;
            proxy_set_header X-Trace-ID $trace_id;
            proxy_set_header Host $host;
        }

        # Form Service API
        location /api/forms/ {
            proxy_pass http://form-service:8000/;
            proxy_set_header X-Trace-ID $trace_id;
            proxy_set_header Host $host;
        }

        # Log Service API
        location /api/logs/ {
            proxy_pass http://log-service:8000/;
            proxy_set_header X-Trace-ID $trace_id;
            proxy_set_header Host $host;
        }

        # Authentication (Zitadel) - forwarding necessary paths if needed or direct access
        # Often Zitadel is accessed directly or via a specific path.
        # Here assuming direct access to port 8080 exposed in docker-compose for Login UI,
        # but if we want to proxy it:
        location /auth/ {
            proxy_pass http://zitadel:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Trace-ID $trace_id;
        }
    }
}
